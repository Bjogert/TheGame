# tasks.yaml - execution queue for coding agents
# States: backlog | in_progress | blocked | done

- id: S0.1a
  title: "Confirm toolchain & baseline run"
  state: done
  deps: []
  deliverables:
    - "Toolchain report recorded in ai_memory (rustup show output, component status)"
    - "`cargo fmt`, `cargo clippy -- -D warnings`, and `cargo check --all-targets` succeed"
    - "`cargo run` launches without errors (close window manually when testing locally)"
  docs_update:
    - ".agent/ai_memory.V.1.yaml"
    - "TASK.md"
  notes:
    - "Active toolchain rustc 1.90.0 (stable); rustfmt and clippy installed via rustup component add."
    - "CLI `cargo run` call times out if the Bevy window is not closed; wgpu emits expected validation-layer warnings."

- id: S0.1b
  title: "Introduce CorePlugin & SimulationClock"
  state: done
  deps: [S0.1a]
  deliverables:
    - "`src/core/plugin.rs` with CorePlugin and SimulationClock resource"
    - "`src/main.rs` updated to register CorePlugin"
    - "Decision captured on whether Bevy Time<Virtual> is sufficient"
  docs_update:
    - "src/core/README.md"
    - "CHANGELOG.md"
    - ".agent/ai_memory.V.1.yaml"
    - "TASK.md"
  notes:
    - "SimulationClock wraps Bevy Time for scaled deltas; keep setter for future config with allow(dead_code) outside tests."
    - "Startup logging confirms configured time scale; unit tests cover scaling and clamping behaviour."

- id: S0.1c
  title: "Add core_debug feature & logging system"
  state: done
  deps: [S0.1b]
  deliverables:
    - "Feature flag `core_debug` defined in Cargo.toml"
    - "Log-once-per-second system gated behind the feature"
    - "VS Code tasks exposing the feature toggle"
  docs_update:
    - "src/core/README.md"
    - "CHANGELOG.md"
    - ".agent/ai_memory.V.1.yaml"
    - "TASK.md"
  notes:
    - "core_debug feature adds repeating timer logging sim elapsed, real/virtual deltas, and scale."
    - "VS Code tasks updated to pass `-- -D warnings` to clippy and expose feature toggles."

- id: S0.2a
  title: "Bootstrap world shell"
  state: done
  deps: [S0.1c]
  deliverables:
    - "`src/world/` modules scaffolded with WorldPlugin"
    - "Ground plane, directional light, and basic camera controller in place"
    - "Assets/config decisions recorded"
  docs_update:
    - "src/world/README.md"
    - ".agent/ai_memory.V.1.yaml"
    - "TASK.md"
  notes:
    - "WorldPlugin spawns plane, light, and fly camera (WASD + Space/LShift, right-mouse look)."
    - "Documentation appended to src/world/README.md; CHANGELOG updated."

- id: S0.2b
  title: "Wire WorldClock & configurable day/night cycle"
  state: done
  deps: [S0.2a]
  deliverables:
    - "WorldClock resource integrated with SimulationClock"
    - "/config/time.toml added and loaded at startup"
    - "Systems reacting to config values for pacing"
  docs_update:
    - "docs/tech_notes.md"
    - "src/world/README.md"
    - "TASK.md"
  notes:
    - "WorldTimeSettings loads from config/time.toml; WorldClock drives sun rotation and ambient lighting."
    - "Cursor grab now leverages CursorOptions for Bevy 0.17 API compliance."

- id: S0.3a
  title: "Docs & automation sweep for milestone S0"
  state: done
  deps: [S0.2b]
  deliverables:
    - "README.md, docs/tech_notes.md, .agent/docs/arch.md refreshed"
    - "CHANGELOG entry for milestone S0"
    - ".agent/tasks.yaml and .agent/ai_memory.V.1.yaml brought current"
  docs_update:
    - "README.md"
    - "docs/tech_notes.md"
    - ".agent/docs/arch.md"
    - ".agent/ai_memory.V.1.yaml"
    - "TASK.md"
  notes:
    - "Documentation sweep captured world time guidance and refreshed architecture snapshot."
    - "Planning artifacts now point to S1.1a as the next active step."

- id: S1.1a
  title: "NPC identity component & debug spawner"
  state: done
  deps: [S0.3a]
  deliverables:
    - "Identity component with placeholder fields"
    - "Spawner creating two debug NPCs (primitive meshes)"
    - "NpcPlugin module documented"
  docs_update:
    - "src/npc/README.md"
    - "CHANGELOG.md"
    - "TASK.md"
  notes:
    - "NpcPlugin spawns three capsule NPCs with unique Identity data."
    - "NpcIdGenerator issues monotonic IDs for future persistence."

- id: S1.1b
  title: "NPC schedule scaffold & integration tests"
  state: done
  deps: [S1.1a]
  deliverables:
    - "Basic schedule system stub (daily tick placeholder)"
    - "Integration test or debug assertion verifying NPC registration"
    - "Follow-up risks recorded in ai_memory"
  docs_update:
    - "src/npc/README.md"
    - ".agent/ai_memory.V.1.yaml"
    - "TASK.md"
  notes:
    - "ScheduleTicker accumulates simulation time and drives tick_schedule_state."

- id: S1.2
  title: "Dialogue scaffolding research"
  state: done
  deps: [S1.1b]
  deliverables:
    - "Document API options + rate limiting strategy"
    - "Draft prompt template approach"
  docs_update:
    - "docs/tech_notes.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Research documented in docs/dialogue_research.md; README/tech notes updated."

- id: S1.3
  title: "Dialogue broker prototype"
  state: done
  deps: [S1.2]
  deliverables:
    - "Implement DialogueBroker trait + provider enum"
    - "Stub request queue with rate limiting"
    - "Surface context-aware errors and response events"
  docs_update:
    - "docs/tech_notes.md"
    - ".agent/ai_memory.V.1.yaml"
    - "CHANGELOG.md"
    - "TASK.md"
  notes:
    - "DialoguePlugin registers queue resources, LocalDialogueBroker, and rate limiting systems."
    - "Requests carry structured context (trade descriptors, schedule notes) and emit response/failure events."

- id: S1.4
  title: "Config-driven micro trade planner"
  state: done
  deps: [S1.3]
  deliverables:
    - "Load recipes and daily requests from config/economy.toml via EconomyRegistry"
    - "Planner creates per-profession ActorTask queues (WaitForGood/Manufacture/Deliver)"
    - "advance_actor_tasks executes queues, waits for partners, and emits TradeCompletedEvent + dialogue prompts"
  docs_update:
    - "docs/tech_notes.md"
    - "docs/plan_overview.md"
    - "CHANGELOG.md"
    - "TASK.md"
  notes:
    - "Villagers now wait at crates, manufacture goods, and deliver them using data-driven plans. Placeholder meshes stay in sync with inventory."
    - ".agent/ai_memory.V.1.yaml"
    - "EconomyPlugin schedules trades after the world clock ticks, logging production/processing/exchange steps."
    - "Trade exchanges enqueue dialogue prompts so NPC chatter reflects the daily loop."
    - "Delivery tasks require both the courier and recipient to be at their crates before completing, keeping exchanges visible."

- id: S1.5
  title: "Economy foundation blueprint"
  state: done
  deps: [S1.4]
  deliverables:
    - "Document data-driven economy plan covering professions, recipes, and inventories"
    - "Identify work order pipeline and event taxonomy updates"
    - "Capture risks/open questions for Step 7"
  docs_update:
    - "docs/economy_blueprint.md"
    - "docs/tech_notes.md"
    - "docs/plan_overview.md"
    - "CHANGELOG.md"
    - "TASK.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Blueprint outlines EconomyRegistry, WorkOrderQueue, and expanded events feeding dialogue/UI."
    - "Risks called out for config sprawl and schedule integration; mitigations drafted."
    - "Upcoming work includes a profession/resource dependency matrix so trade relationships stay readable as new jobs arrive."

- id: S1.6
  title: "NPC locomotion & profession crates"
  state: done
  deps: [S1.5]
  deliverables:
    - "Profession crate entities spawned for farmer, miller, and blacksmith"
    - "Micro trade loop assigns crate destinations before processing work orders"
    - "NpcLocomotion component/system moves villagers toward their targets"
    - "Movement telemetry logged on travel start and arrival"
  docs_update:
    - "TASK.md"
    - "AGENT.md"
    - "src/npc/README.md"
    - "src/economy/README.md"
    - "docs/tech_notes.md"
  notes:
    - "Trade loop now pauses until all professions reach their crates, providing visible build-up to exchanges."
    - "Locomotion entries capture destination labels for future UI surfacing."

- id: S1.7
  title: "NPC motivation & wellbeing spike"
  state: done
  deps: [S1.6]
  deliverables:
    - "Dopamine-style motivation resource per NPC with decay and reward hooks"
    - "Mood thresholds mapped to behaviour, dialogue, and production modifiers"
    - "Alcohol coping effect modelled with quality penalties and post-binge crashes"
    - "Motivation inputs linked to the economy dependency matrix"
  docs_update:
    - "docs/tech_notes.md"
    - "BigPicturePlan.md"
    - "docs/plan_overview.md"
    - "TASK.md"
    - "README.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "NpcMotivation component plus config-driven tuning rewards work, dialogue, and leisure while hooking into the economy dependency matrix after the world day advances."
    - "Alcohol boosts feed into hangover penalties and reduced task rewards; leisure no longer fakes food access and daily dependency snapshots only satisfy categories backed by matching goods."

- id: S1.8
  title: "Dialogue telemetry persistence"
  state: done
  deps: [S1.7]
  deliverables:
    - "DialogueTelemetryLog resource mirrors the in-memory telemetry buffer to disk"
    - "logs/dialogue_history.jsonl accumulates JSONL entries for responses and failures"
    - "Documentation and planning artifacts updated with log usage and revised backlog"
  docs_update:
    - "README.md"
    - "docs/tech_notes.md"
    - "src/dialogue/README.md"
    - "CHANGELOG.md"
    - "TASK.md"
    - "BigPicturePlan.md"
    - "docs/plan_overview.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Telemetry persistence runs immediately after queue processing so the JSONL log matches UI-visible history."
    - "logs/ is ignored from version control to prevent accidental commits of local dialogue history."

- id: S1.9
  title: "Baseline verification & responsibility map"
  state: done
  deps: [S1.8]
  deliverables:
    - "`cargo fmt`, `cargo clippy -D warnings`, and `cargo check --all-targets` executed on the refreshed codebase"
    - "Responsibility summary for core, world, npc, dialogue, and economy modules captured in planning docs"
    - "Environment caveats (Wayland pkg-config gap) logged alongside baseline results"
  docs_update:
    - "AGENT.md"
    - "TASK.md"
    - "docs/tech_notes.md"
    - "BigPicturePlan.md"
    - "docs/plan_overview.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Hosted containers still lack `libwayland-dev`; document the limitation so failed linting is not misattributed to code."
    - "Responsibility map covers plugin ordering, shared resources, and dialogue/economy touch points post-refactor."

- id: S1.10
  title: "Economy & dialogue literal audit"
  state: done
  deps: [S1.9]
  deliverables:
    - "OpenAI defaults centralised in `dialogue::broker::config`"
    - "Trade placeholder offsets, crate labels, and locomotion tolerances expressed as module constants"
    - "Documentation updated to mention new constants/config entries"
  docs_update:
    - "README.md"
    - "TASK.md"
    - "docs/tech_notes.md"
    - "src/dialogue/README.md"
    - "src/economy/README.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Removed the last ad-hoc offsets from task execution; placeholders now reference shared constants."
    - "Dialogue broker defaults clearly document how to override environment variables."

- id: S1.11
  title: "Systems modularisation"
  state: done
  deps: [S1.10]
  deliverables:
    - "Economy systems split into `spawning`, `day_prep`, `task_execution`, and `dialogue` submodules"
    - "Dialogue broker extracted into `broker/mod.rs`, `broker/config.rs`, and `broker/openai.rs`"
    - "Module docs refreshed to describe the new layout"
  docs_update:
    - "TASK.md"
    - "CHANGELOG.md"
    - "BigPicturePlan.md"
    - "docs/tech_notes.md"
    - "README.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Each file now sits below the 400-line guideline called out in AGENT.md."
    - "`mod.rs` files re-export previous symbols to avoid churn in dependants."

- id: S1.12
  title: "Dead code sweep"
  state: done
  deps: [S1.11]
  deliverables:
    - "`cargo clippy -D warnings -- -D dead_code` run to surface unused definitions"
    - "Redundant helpers/imports removed across dialogue and economy modules"
    - "Docs updated with the cleanup summary and remaining follow-ups"
  docs_update:
    - "CHANGELOG.md"
    - "docs/tech_notes.md"
    - "TASK.md"
    - "AGENT.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Telemetry and event hooks verified after removals to ensure NPC motivation and trade pipelines still fire."
    - "Cleanup unblocked upcoming UI telemetry work by reducing noise in the modules."

- id: S1.13
  title: "Dialogue broker verification & instrumentation"
  state: done
  deps: [S1.12]
  deliverables:
    - "Expose runtime indicator (log + telemetry) confirming when OpenAI live mode is active vs fallback"
    - "Add a debug command/system to enqueue a sample conversation so API wiring can be smoke-tested on demand"
    - "Capture broker errors and rate limits in logs/dialogue_history.jsonl with actionable messages"
  docs_update:
    - "src/dialogue/README.md"
    - "CHANGELOG.md"
    - "docs/tech_notes.md"
    - "TASK.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Ensures developers immediately know whether real OpenAI responses are flowing before chasing gameplay bugs."
    - "Sample handshake should reuse existing DialogueRequestQueue paths to avoid bespoke code paths."

- id: S1.14
  title: "Conversational triggers & prompt revamp"
  state: backlog
  deps: [S1.13]
  deliverables:
    - "Add event-driven dialogue triggers for greetings, status check-ins, and trade haggling grounded in proximity/schedule cues"
    - "Expand DialogueContext builders with mood, recent activities, and trade metadata to enrich prompts"
    - "Refine prompt templates and topic hints so responses reference shared world state"
  docs_update:
    - "src/dialogue/README.md"
    - "src/economy/README.md"
    - "src/npc/README.md"
    - "docs/tech_notes.md"
    - "TASK.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Initial trigger set should cover morning greetings, crate-side haggling, and schedule recaps to prove loop diversity."
    - "Keep rate limits in mind by batching dialog opportunities and reusing cooldown infrastructure."

- id: S1.15
  title: "NPC needs & self-directed decisions"
  state: backlog
  deps: [S1.14]
  deliverables:
    - "Introduce an `NpcNeeds` component tracking hunger, thirst, rest, and social desire with configurable decay/recovery"
    - "Wire a lightweight decision system that weighs needs/motivation to pick the next activity or dialogue topic"
    - "Integrate economy tasks with need states so villagers can defer work or seek resources when thresholds dip"
  docs_update:
    - "src/npc/README.md"
    - "src/economy/README.md"
    - "docs/plan_overview.md"
    - "docs/tech_notes.md"
    - "TASK.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Start with deterministic scoring so behaviour remains debuggable before layering randomness."
    - "Expose telemetry hooks so UI/debug overlays can visualise needs and resulting decisions."

- id: S1.16a
  title: "Speech bubble MVP - Basic text above NPCs"
  state: done
  deps: [S1.13]
  deliverables:
    - "Create src/ui/speech_bubble/ module with components (SpeechBubble, SpeechBubbleSettings, SpeechBubbleTracker, SpeechBubbleUiRoot)"
    - "Spawn UI NodeBundle entities from DialogueResponseEvent positioned via camera.world_to_viewport()"
    - "Implement full-screen UI root overlay for bubble container"
    - "Add lifetime timer system with fade-out during final 2 seconds, despawn after 10 seconds"
    - "Register SpeechBubblePlugin in main.rs after DialoguePlugin"
  docs_update:
    - "src/ui/speech_bubble/README.md"
    - "CHANGELOG.md"
    - "TASK.md"
    - ".agent/ai_memory.V.1.yaml"
    - ".agent/tasks.yaml"
  notes:
    - "IMPLEMENTATION CHANGED: Replaced Text2d world-space approach with UI NodeBundle screen-space positioning."
    - "Bubbles are UI nodes with dark semi-transparent backgrounds (Color::srgba(0.1, 0.1, 0.1, 0.85))."
    - "Positioning via camera.world_to_viewport() converts NPC 3D positions to 2D screen coordinates every frame."
    - "SpeechBubbleTracker ensures one bubble per NPC; updating existing bubble resets timer and content."
    - "Distance culling (25 world units default) hides bubbles when NPCs are far from camera."
    - "Fade-out calculated from lifetime.remaining_secs() with smooth alpha interpolation."
    - "Module files kept under 400 lines: components.rs (123), systems.rs (200), plugin.rs (45), mod.rs (19)."

- id: S1.16b
  title: "Speech bubble visual polish - Distance culling & fade"
  state: backlog
  deps: [S1.16a]
  deliverables:
    - "Implement distance-based visibility culling (hide bubbles beyond max_distance)"
    - "Add fade-out animation (alpha lerp during final 2 seconds of lifetime)"
    - "Adjust Y-offset to position bubbles above NPC capsule meshes"
    - "Add word wrapping system (keep lines under 40 characters)"
  docs_update:
    - "src/ui/speech_bubble/README.md"
    - "docs/tech_notes.md"
    - "TASK.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Distance culling creates natural 'harder to read far away' effect per design requirements."
    - "Max distances: Whisper 15u, Normal 25u, Loud 40u (configurable in code for now)."
    - "Fade-out uses Color alpha channel interpolation with smooth easing."

- id: S1.16c
  title: "Speech bubble personality - Volume & mood integration"
  state: backlog
  deps: [S1.16b]
  deliverables:
    - "Implement SpeechVolume enum (Whisper/Normal/Loud) with font size multipliers"
    - "Auto-detect volume from dialogue content (CAPS = Loud, short/whisper keywords = Whisper)"
    - "Integrate with NpcMotivation.mood (Depressed = quieter, Energised = louder)"
    - "Add optional per-NPC personality traits affecting default volume"
  docs_update:
    - "src/ui/speech_bubble/README.md"
    - "src/npc/README.md"
    - "docs/tech_notes.md"
    - "CHANGELOG.md"
    - "TASK.md"
    - ".agent/ai_memory.V.1.yaml"
  notes:
    - "Font sizes: Whisper 18pt (0.6x), Normal 24pt (1.0x), Loud 36pt (1.5x)."
    - "Volume detection keywords: 'whisper', 'quietly', 'shout', 'yell', plus CAPS ratio."
    - "Mood modifiers: Depressed -20% size, Energised +20% size, applied on top of base volume."
    - "Future: add Personality component with Boisterous/Shy traits for persistent volume offsets."
